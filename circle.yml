machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

dependencies:
  pre:
    - docker version
    - sudo pip install mkdocs
    - sudo pip install pymdown-extensions
    - sudo make validate
  override:
    - sudo make binary

test:
  override:
    - sudo make test-unit
#    - sudo make test-integration
  post:
    - sudo make binary
    - sudo make image

deployment:
  aws:
    branch: add_newrelic_monitoring
    commands:
      - eval "$(aws ecr get-login --region eu-west-1)"
      - docker build -t 074067892588.dkr.ecr.eu-west-1.amazonaws.com/wgs/traefik:master .
      - docker push 074067892588.dkr.ecr.eu-west-1.amazonaws.com/wgs/traefik:master

#deployment:
#  hub:
#    branch: master
#    commands:
#      - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --prerelease ${VERSION} dist/
#      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
#      - docker push ${REPO,,}:latest
#      - docker tag ${REPO,,}:latest ${REPO,,}:${VERSION}
#      - docker push ${REPO,,}:${VERSION}
